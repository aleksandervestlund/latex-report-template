\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{packages}

% +---------------------------------+
% |        Table of Contents        |
% +---------------------------------+
% | 1. Page setup                   |
% | 2. Document structure           |
% | 3. Mathematics                  |
% | 4. Figures and tables           |
% | 5. Code                         |
% | 6. Algorithms                   |
% | 7. Bibliography                 |
% | 8. Referencing                  |
% | 9. General                      |
% | 10. Page layout and formatting  |
% | 11. Numbering within sections   |
% | 12. Language                    |
% +---------------------------------+

% ----------- Page setup ------------
\RequirePackage[
  l2tabu,
  orthodox,
]{nag}
\RequirePackage[utf8]{inputenc}
\RequirePackage[T1]{fontenc}
\RequirePackage[main=]{babel}
\RequirePackage[
  babel,
  expansion,
  protrusion,
]{microtype}
\RequirePackage{lmodern}
\DeclareSymbolFont{largesymbols}{OMX}{cmex}{m}{n}
\RequirePackage[
  a4paper,
  total={
    150mm,
    245mm,
    footskip=14mm,
  },
]{geometry}
\RequirePackage[onehalfspacing]{setspace}

\setlength{\parskip}{0.8em}
\pdfgentounicode=1
\sloppy

\RequirePackage{silence}
\WarningFilter{latex}{Command \showhyphens has changed.}
\WarningFilter{latex}{Command `\theH}

% ------- Document structure --------
\RequirePackage{etoolbox}
\patchcmd{\abstract}{\small}{}{}{}

\newcommand{\keywordsname}{Keywords}
\newcommand{\keywords}[1]{
  \textbf{\emph{\keywordsname}} \--- #1
}

\newcommand{\frontmatter}{
  \pagenumbering{roman}
}
\newcommand{\mainmatter}{
  \newpage
  \pagenumbering{arabic}
}

\RequirePackage{appendix}
\newcommand{\addappendix}{
  \phantomsection
  \newpage
  \appendix
  \section*{\appendixname}
  \addcontentsline{toc}{section}{\appendixname}
  \renewcommand{\thesubsection}{\Alph{subsection}}
}

\RequirePackage{afterpage}
\newcommand{\blankinfo}{This page was intentionally left blank}
\newcommand{\blankpage}{
  \phantomsection
  \newpage
  \hbox{}
  \vfill
  {\centering \MakeUppercase{\blankinfo}\par}
  \vfill
  \thispagestyle{empty}
  \addtocounter{page}{-1}
  \newpage
}

% ----------- Mathematics -----------
\RequirePackage{latexsym}
\RequirePackage{amsfonts}
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsthm}
\RequirePackage{bm}
\RequirePackage{calc}
\RequirePackage[makeroom]{cancel}
\RequirePackage{commath}
\RequirePackage[
  ISO,
  mleftright,
  spaced=1,
]{diffcoeff}
\RequirePackage{faktor}
\RequirePackage{mathrsfs}
\RequirePackage{mathtools}
\RequirePackage{nicefrac}
\RequirePackage{thmtools}

% Both English and Norwegian versions
\declaretheorem[numberwithin=section]{
  assumption,antagelse,
  case,tilfelle,
  claim,påstand,
  corollary,korollar,
  definition,definisjon,
  example,eksempel,
  exercise,oppgave,
  fact,faktum,
  invariant,
  lemma,
  observation,observasjon,
  principle,prinsipp,
  property,egenskap,
  proposition,forslag,
  problem,
  step,trinn,
  theorem,teorem  % Cannot have trailing comma
}
\declaretheorem[style=remark]{
  remark,merk
}

\newcommand{\proofideatext}{Proof Idea}
\newcommand{\proofsketchtext}{Proof Sketch}
\newenvironment{proofidea}
  {\renewcommand{\qedsymbol}{}\begin{proof}[\proofideatext]}
  {\end{proof}}
\newenvironment{proofsketch}
  {\begin{proof}[\proofsketchtext]}
  {\end{proof}}

\newcommand{\cif}[1]{\text{if $#1$}}
\newcommand{\cwhen}[1]{\text{when $#1$}}
\newcommand{\cotherwise}{\text{otherwise}}

\newlength{\savearraycolsep}
\newcommand{\narrowarray}[1]{\setlength{\savearraycolsep}{\arraycolsep}\setlength{\arraycolsep}{#1\arraycolsep}}
\newcommand{\normalarray}{\setlength{\arraycolsep}{\savearraycolsep}}

\newcommand{\coleq}{\mathrel{\vcentcolon =}}
\newcommand{\defeq}{\mathrel{\overset{\text{def}}{=}}}
\newcommand{\hateq}{\mathrel{\hat{=}}}
\newcommand{\meq}{\mathrel{\overset{\text{m}}{=}}}
\newcommand{\qmeq}{\mathrel{\overset{\text{?}}{=}}}
\newcommand{\whateq}{\mathrel{\widehat{=}}}

\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}
\DeclarePairedDelimiter{\floor}{\lfloor}{\rfloor}

\DeclareMathOperator{\Adj}{Adj}
\DeclareMathOperator{\lcm}{lcm}

\DeclareMathOperator{\Cov}{Cov}
\DeclareMathOperator{\Var}{Var}

\DeclareMathOperator{\Dec}{Dec}
\DeclareMathOperator{\Enc}{Enc}
\DeclareMathOperator{\Eval}{Eval}
\DeclareMathOperator{\Gen}{Gen}
\DeclareMathOperator{\Inv}{Inv}
\DeclareMathOperator{\KeyGen}{KeyGen}

\DeclareMathOperator{\Extend}{Extend}
\DeclareMathOperator{\Seal}{Seal}
\DeclareMathOperator{\Unseal}{Unseal}

\DeclareMathOperator{\negl}{\mathsf{negl}}
\DeclareMathOperator{\poly}{\mathsf{poly}}
\DeclareMathOperator{\polylog}{\mathsf{polylog}}

\newcommand{\perm}[2]{{}^{#1}P_{#2}}
\newcommand{\comb}[2]{{}^{#1}C_{#2}}
\renewcommand{\choose}[2]{\dbinom{#1}{#2}}

\newcommand{\littleo}[1]{o \! \del{#1}}
\newcommand{\bigO}[1]{\mathcal{O} \! \del{#1}}
\newcommand{\bigTheta}[1]{\Theta \! \del{#1}}
\newcommand{\bigOmega}[1]{\Omega \! \del{#1}}
\newcommand{\littleomega}[1]{\omega \! \del{#1}}

\newcommand{\amortized}[1]{\widehat{#1}}
\newcommand{\compl}[1]{{}^\mathsf{c} \! #1}
\newcommand{\defn}[1]{\textit{\textbf{\boldmath #1}}}
\newcommand{\expect}[1]{\mathbb{E} \! \del{#1}}
\newcommand{\expectsq}[1]{\mathbb{E}^2 \! \del{#1}}
\newcommand{\matx}[2]{\del{\!\!\!\begin{array}{*{#1}{c}}#2\end{array}\!\!\!}}
\newcommand{\percent}[1]{#1\%}

\newcommand{\naturals}{\mathbb{N}}
\newcommand{\integers}{\mathbb{Z}}
\newcommand{\fractions}{\mathbb{Q}}
\newcommand{\reals}{\mathbb{R}}
\newcommand{\complex}{\mathbb{C}}
\newcommand{\field}{\mathbb{F}}
\newcommand{\laplace}{\mathscr{L}}

\newcommand{\goesto}{\rightarrow}
\newcommand{\nequiv}{\not\equiv}
\newcommand{\transpose}{^{\mathsf{T}}}
\newcommand{\xor}{\mathbin{\oplus}}

\RequirePackage{newunicodechar}
\newunicodechar{≠}{\neq}
\newunicodechar{≈}{\approx}
\newunicodechar{≤}{\leq}
\newunicodechar{≥}{\geq}

\RequirePackage{aliascnt}
\newaliascnt{ineq}{equation}
\aliascntresetthe{ineq}

\makeatletter
\def\inequality{$$\refstepcounter{ineq}}
\def\endinequality{\eqno \hbox{\@eqnnum}$$\@ignoretrue}
\makeatother

% ------- Figures and tables --------
\RequirePackage{graphicx}
\RequirePackage{wrapfig}
\RequirePackage{tabularray}
\RequirePackage[
  figureposition=bottom,
  font=onehalfspacing,
  labelfont=bf,
  tableposition=top,
]{caption}
\RequirePackage{subcaption}
\RequirePackage[nottoc]{tocbibind}

\RequirePackage{tablefootnote}
\newcommand{\footnotenonumber}[1]{{\def\thempfn{}\footnotetext{#1}}}
\newcommand{\footnotetight}[1]{\footnote{\renewcommand\baselinestretch{1}\footnotesize #1}}

\RequirePackage[
  dvipsnames,
  table,
  xcdraw,
]{xcolor}

\RequirePackage{floatrow}
\floatsetup[figure]{capposition=bottom}
\floatsetup[subfigure]{capposition=bottom}
\floatsetup[table]{capposition=top}

\setcounter{topnumber}{3}
\setcounter{bottomnumber}{1}
\setcounter{totalnumber}{5}
\setcounter{dbltopnumber}{2}

\renewcommand{\topfraction}{0.7}
\renewcommand{\bottomfraction}{0.3}
\renewcommand{\textfraction}{0.1}
\renewcommand{\floatpagefraction}{0.7}
\renewcommand{\dbltopfraction}{0.7}
\renewcommand{\dblfloatpagefraction}{0.7}

\RequirePackage{xspace}
\RequirePackage[export]{adjustbox}
\RequirePackage{float}  % Must load after floatrow
\RequirePackage{longtable}
\RequirePackage{lscape}
\RequirePackage{multicol}
\RequirePackage{multirow}
\RequirePackage[section]{placeins}
\RequirePackage{makecell}
\renewcommand{\theadfont}{\bfseries}

\newcommand{\HRule}{
  \rule{\linewidth}{0.5mm}
}
\newcommand{\mitlogo}{Images/MIT_logo.png}
\newcommand{\ntnulogo}{Images/NTNU_logo_EN.png}
\newcommand{\snulogo}{Images/SNU_logo.png}

\makeatletter
\renewcommand*{\listof}[2]{
  \@ifundefined{ext@#1}{\float@error{#1}}{
    \expandafter\let\csname l@#1\endcsname \l@figure
    \float@listhead{#2}
    \addcontentsline{toc}{section}{#2}
    \begingroup
      \@starttoc{\@nameuse{ext@#1}}
    \endgroup
  }
}
\makeatother

% -------------- Code ---------------
\RequirePackage{listings}
\RequirePackage{dirtree}

\RequirePackage{minted}
\setminted{
  breaklines=true,
  mathescape,
  style=default,
}
\fvset{baselinestretch=1}

\RequirePackage[most]{tcolorbox}
\tcbset{
  enhanced,
  hyphenationfix,
  oversize,
}

% Ignore warnings
\BeforeBeginEnvironment{minted}{\begin{tcolorbox}}
\AfterEndEnvironment{minted}{\end{tcolorbox}}

\let\oldinputminted\inputminted
\RenewDocumentCommand{\inputminted}{O{} m m}{
  \begin{tcolorbox}
    \oldinputminted[#1]{#2}{#3}
  \end{tcolorbox}
}

% ----------- Algorithms ------------
% Alternatively, check out clrscode4e: https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/11599/clrscode4e.pdf
\RequirePackage{algorithm}
\RequirePackage{algpseudocode}
\RequirePackage{morewrites}

% TODO: Investigate \theH warnings
\RequirePackage[
  advantage,
  adversary,
  asymptotics,
  events,
  ff,
  keys,
  lambda,
  landau,
  mm,
  notions,
  operators,
  primitives,
  probability,
  sets,
]{cryptocode}

\RequirePackage{newfloat}
\newfloat{procedure}{tbp}{lop}
\newcommand{\listprocedurename}{List of Procedures}
\newcommand{\listofprocedures}{\listof{procedure}{\listprocedurename}}

% ---------- Bibliography -----------
\RequirePackage[
  backend=biber,
  dashed=false,
  dateabbrev=false,
  doi=true,
  giveninits=true,
  isbn=true,
  maxbibnames=99,
  maxcitenames=2,
  sortcites=true,
  style=ext-authoryear-ecomp,
  uniquename=init,
  urldate=long,
]{biblatex}
\addbibresource{references.bib}
\DeclareNameAlias{sortname}{family-given}
\DeclareDelimFormat{nameyeardelim}{\addcomma\space}
\DeclareOuterCiteDelims{cite}{\bibopenbracket}{\bibclosebracket}
\DeclareInnerCiteDelims{textcite}{\bibopenbracket}{\bibclosebracket}

% ----------- Referencing -----------
\RequirePackage[
  unicode,
  colorlinks,
  citecolor=black,
  filecolor=black,
  linkcolor=black,
  urlcolor=black,
]{hyperref}
\RequirePackage[norefs]{refcheck}  % Remove "norefs" for debugging

% TODO: Switch to zref-clever when it supports Norwegian
\RequirePackage[
  capitalise,
  nameinlink,
  noabbrev,
]{cleveref}  % Must load after amsmath, babel and hyperref
\creflabelformat{ineq}{#2\textup{(#1)}#3}

\newcommand{\creflastconjunction}{ og~}
\newcommand{\creflastgroupconjunction}{ og~}

\makeatletter
\cref@addlanguagedefs{american}{
  \if@cref@capitalise
    \crefname{ineq}{Inequality}{Inequalities}
    \crefname{subsection}{Subsection}{Subsections}
    \crefname{subsubsection}{Subsubsection}{Subsubsections}
    \crefformat{procedure}{Procedure~#2#1#3}
    \crefrangeformat{procedure}{Procedures~#3#1#4 to~#5#2#6}
    \crefmultiformat{procedure}{Procedures~#2#1#3}{ and~#2#1#3}{, #2#1#3}{, and~#2#1#3}
  \else
    \crefname{ineq}{inequality}{inequalities}
    \crefname{subsection}{subsection}{subsections}
    \crefname{subsubsection}{subsubsection}{subsubsections}
    \crefformat{procedure}{procedure~#2#1#3}
    \crefrangeformat{procedure}{procedures~#3#1#4 to~#5#2#6}
    \crefmultiformat{procedure}{procedures~#2#1#3}{ and~#2#1#3}{, #2#1#3}{, and~#2#1#3}
  \fi
}
\cref@addlanguagedefs{british}{
  \if@cref@capitalise
    \crefname{ineq}{Inequality}{Inequalities}
    \crefname{subsection}{Subsection}{Subsections}
    \crefname{subsubsection}{Subsubsection}{Subsubsections}
    \crefformat{procedure}{Procedure~#2#1#3}
    \crefrangeformat{procedure}{Procedures~#3#1#4 to~#5#2#6}
    \crefmultiformat{procedure}{Procedures~#2#1#3}{ and~#2#1#3}{, #2#1#3}{, and~#2#1#3}
  \else
    \crefname{ineq}{inequality}{inequalities}
    \crefname{subsection}{subsection}{subsections}
    \crefname{subsubsection}{subsubsection}{subsubsections}
    \crefformat{procedure}{procedure~#2#1#3}
    \crefrangeformat{procedure}{procedures~#3#1#4 to~#5#2#6}
    \crefmultiformat{procedure}{procedures~#2#1#3}{ and~#2#1#3}{, #2#1#3}{, and~#2#1#3}
  \fi
}
\cref@addlanguagedefs{norsk}{
  \if@cref@capitalise
    \crefname{ineq}{Ulikhet}{Ulikheter}
    \crefname{subsection}{Underseksjon}{Underseksjoner}
    \crefname{subsubsection}{Underunderseksjon}{Underunderseksjon}
    \crefformat{procedure}{Prosedyre~#2#1#3}
    \crefrangeformat{procedure}{Prosedyrer~#3#1#4 til~#5#2#6}
    \crefmultiformat{procedure}{Prosedyrer~#2#1#3}{ og~#2#1#3}{, #2#1#3}{, og~#2#1#3}
  \else
    \crefname{ineq}{ulikhet}{ulikheter}
    \crefname{subsection}{underseksjon}{underseksjoner}
    \crefname{subsubsection}{underunderseksjon}{underunderseksjon}
    \crefformat{procedure}{prosedyre~#2#1#3}
    \crefrangeformat{procedure}{prosedyrer~#3#1#4 til~#5#2#6}
    \crefmultiformat{procedure}{prosedyrer~#2#1#3}{ og~#2#1#3}{, #2#1#3}{ og~#2#1#3}
  \fi
}
\newcommand{\refcheckize}[1]{%
  \expandafter\let\csname @@\string#1\endcsname#1%
  \expandafter\DeclareRobustCommand\csname relax\string#1\endcsname[1]{%
    \csname @@\string#1\endcsname{##1}%
    \@for\@temp:=##1\do{%
      \wrtusdrf{\@temp}%
      \wrtusdrf{{\@temp}}%
    }%
  }%
  \expandafter\let\expandafter#1\csname relax\string#1\endcsname%
}
\makeatother

\refcheckize{\cref}
\refcheckize{\Cref}

\newcommand{\alglabel}[1]{\label{alg:#1}}
\newcommand{\caselabel}[1]{\label{case:#1}}
\newcommand{\corlabel}[1]{\label{cor:#1}}
\newcommand{\eqlabel}[1]{\label{eq:#1}}
\newcommand{\figlabel}[1]{\label{fig:#1}}
\newcommand{\ineqlabel}[1]{\label{ineq:#1}}
\newcommand{\lemlabel}[1]{\label{lem:#1}}
\newcommand{\lstlabel}[1]{\label{lst:#1}}
\newcommand{\prolabel}[1]{\label{pro:#1}}
\newcommand{\seclabel}[1]{\label{sec:#1}}
\newcommand{\subseclabel}[1]{\label{subsec:#1}}
\newcommand{\subsubseclabel}[1]{\label{subsubsec:#1}}
\newcommand{\tablabel}[1]{\label{tab:#1}}
\newcommand{\thmlabel}[1]{\label{thm:#1}}

\PassOptionsToPackage{lang-warn=false}{datatool-base}
% More styles: https://www.dickimaw-books.com/gallery/glossaries-styles/
\RequirePackage[
  abbreviations,
  acronyms,
  % nomain,
  shortcuts,
  style=altlong4col,
  symbols,
  translate=babel,
]{glossaries-extra}  % Must load after hyperref

\newcommand{\symboltype}{symbols}
\newcommand{\initialismtype}{initialism}
\newcommand{\initialismname}{Initialisms}
\newglossary*{\initialismtype}{\initialismname}
\NewDocumentCommand{\newinitialism}{O{} m m m}{
  \newabbreviation[type=\initialismtype,#1]{#2}{#3}{#4}
}

\loadglsentries{glossary}  % Loading "glossary.tex"

\setabbreviationstyle{long-short}
\setabbreviationstyle[\acronymtype]{long-short}

\setlength{\glsdescwidth}{0.61\linewidth}  % Minmax this
% \GlsXtrEnableEntryCounting{\acronymtype,abbreviation}{2}  % Requires \makeglossaries and not \makenoidxglossaries

\renewcommand{\printglossaries}{
  \iflanguage{norsk}{
    \renewcommand{\abbreviationsname}{Forkortelser}
    \renewcommand{\acronymname}{Akronymer}
    \printglossary[type=\acronymtype]
    \printglossary[type=\initialismtype]
    \printglossary[type=\glsxtrabbrvtype]
    \printglossary
    \printglossary[type=\symboltype]
  }{
    \printglossary[type=\glsxtrabbrvtype]
    \printglossary[type=\acronymtype]
    \printglossary
    \printglossary[type=\initialismtype]
    \printglossary[type=\symboltype]
  }
}

% ------------- General -------------
\RequirePackage[
  shortcuts,
  wordspacearound,
]{extdash}
\RequirePackage[per-mode=symbol]{siunitx}

\newcommand{\datestring}{Date}
\RequirePackage[
  level,
  nodayofweek,
]{datetime}

\RequirePackage{booktabs}
\RequirePackage{comment}
\RequirePackage{csquotes}  % Must load after minted
\RequirePackage{lipsum}
\RequirePackage{paralist}
\RequirePackage{pdfpages}

\RequirePackage{enumitem}
\setlist[enumerate,1]{label=(\arabic*)}
\setlist[enumerate,2]{label=(\alph*)}

\RequirePackage{xurl}
\urlstyle{same}

% --- Page layout and formatting ----
\RequirePackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0.1ex}
\renewcommand{\footrulewidth}{0.1ex}
\fancyfoot[C]{\thepage}

\newcommand{\Romannumeral}[1]{
  \MakeUppercase{\romannumeral{#1}}
}

% ---- Numbering within sections ----
% \setcounter{secnumdepth}{0}
\makeatletter
\ifnum\c@secnumdepth > 0
  \numberwithin{figure}{section}
  \numberwithin{table}{section}
  \numberwithin{algorithm}{section}
  \numberwithin{listing}{section}
  \numberwithin{procedure}{section}
\fi
\makeatother

% ------------ Language -------------
\addto{\captionsamerican}{
  \floatname{procedure}{Procedure}
  \renewcommand{\contentsname}{Table of Contents}
  \renewcommand{\abbreviationsname}{Abbreviations}
  \renewcommand{\creflastconjunction}{, and~}
  \renewcommand{\creflastgroupconjunction}{, and~}
}
\addto{\captionsbritish}{
  \floatname{procedure}{Procedure}
  \renewcommand{\contentsname}{Table of Contents}
  \renewcommand{\abbreviationsname}{Abbreviations}
  \renewcommand{\creflastconjunction}{, and~}
  \renewcommand{\creflastgroupconjunction}{, and~}
}
\addto{\captionsnorsk}{
  \floatname{procedure}{Prosedyre}
  \renewcommand{\algorithmname}{Algoritme}
  \renewcommand{\appendixname}{Vedlegg}
  \renewcommand{\blankinfo}{Denne siden er med hensikt blank}
  \renewcommand{\contentsname}{Innholdsfortegnelse}
  \renewcommand{\datestring}{Dato}
  \renewcommand{\initialismname}{Forbokstavord}
  \renewcommand{\keywordsname}{Nøkkelord}
  \renewcommand{\listalgorithmname}{Algoritmer}
  \renewcommand{\listingscaption}{Opplisting}
  \renewcommand{\listoflistingscaption}{Opplistinger}
  \renewcommand{\listprocedurename}{Prosedyrer}
  \renewcommand{\listtheoremname}{Teoremer}
  \renewcommand{\proofideatext}{Bevisidé}
  \renewcommand{\proofsketchtext}{Bevisutkast}
  \renewenvironment{assumption}{\begin{antagelse}}{\end{antagelse}}
  \renewenvironment{case}{\begin{tilfelle}}{\end{tilfelle}}
  \renewenvironment{claim}{\begin{påstand}}{\end{påstand}}
  \renewenvironment{corollary}{\begin{korollar}}{\end{korollar}}
  \renewenvironment{definition}{\begin{definisjon}}{\end{definisjon}}
  \renewenvironment{example}{\begin{eksempel}}{\end{eksempel}}
  \renewenvironment{exercise}{\begin{oppgave}}{\end{oppgave}}
  \renewenvironment{fact}{\begin{faktum}}{\end{faktum}}
  \renewenvironment{observation}{\begin{observasjon}}{\end{observasjon}}
  \renewenvironment{principle}{\begin{prinsipp}}{\end{prinsipp}}
  \renewenvironment{property}{\begin{egenskap}}{\end{egenskap}}
  \renewenvironment{proposition}{\begin{forslag}}{\end{forslag}}
  \renewenvironment{remark}{\begin{merk}}{\end{merk}}
  \renewenvironment{theorem}{\begin{teorem}}{\end{teorem}}
  \renewenvironment{step}{\begin{trinn}}{\end{trinn}}
  \renewcommand{\ntnulogo}{Images/NTNU_logo_NB.png}
  \setlength{\parindent}{0em}
}

\ifthenelse{\equal{\languagename}{norsk}}{
  \RequirePackage{icomma}
}{}
